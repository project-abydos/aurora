<HTML>

<HEAD>
	<TITLE>Air Force Automated Maintenance System</TITLE>
	<META content=text/html;charset=utf-8 http-equiv=Content-Type>
	<STYLE type=text/css>
		BODY {
			BACKGROUND-COLOR: #ffffff
		}

		.title3 {
			FONT-SIZE: 18pt;
			FONT-FAMILY: "Times New Roman";
			FONT-WEIGHT: bold;
			COLOR: #000090;
			FONT-STYLE: italic
		}

		.title4 {
			FONT-SIZE: 10pt;
			FONT-FAMILY: Tahoma;
			FONT-WEIGHT: bold
		}

		.boxborder {
			BACKGROUND-COLOR: #e8e1e1
		}

		.text2 {
			FONT-SIZE: 14px;
			FONT-FAMILY: Tahoma, Helvetica, sans-serif
		}
	</STYLE>

</HEAD>

<BODY>
	<DIV id=div1 class=boxborder style="BORDER-TOP: thin outset; BORDER-RIGHT: thin outset; WIDTH: 868px; BORDER-BOTTOM: thin outset; PADDING-BOTTOM: 25px; PADDING-TOP: 25px; PADDING-LEFT: 25px; MARGIN-LEFT: 100px; BORDER-LEFT: thin outset; PADDING-RIGHT: 25px">
		<TABLE style="WIDTH: 100%">
			<TBODY>
				<TR>
					<TD class=title3 style="TEXT-ALIGN: center" colSpan=2>IMDS CDB </TD>
				</TR>
				<TR>
					<TD>&nbsp;</TD>
				</TR>
				<TR>
					<TD class=title4 style="TEXT-ALIGN: center" colSpan=2>To process concurrent TIP sessions you must access each one from a separate browser window. </TD>
				</TR>
				<TR>
					<TD>&nbsp;</TD>
				</TR>
				<TR>
					<TD class=title4 colSpan=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1). Close This Window</TD>
				</TR>
				<TR>
					<TD class=title4 colSpan=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2). Open A New Browser By Clicking Your Shortcut Button or the IE button on
						your toolbar </TD>
				</TR>
				<TR>
					<TD>&nbsp;</TD>
				</TR>
				<TR>
					<TD>&nbsp;</TD>
				</TR>
				<TR>
					<TD>&nbsp;</TD>
				</TR>
				<TR class=text2>
					<TD>&nbsp;&nbsp;&nbsp;&nbsp;Logged On Via:&nbsp;&nbsp;
						<SPAN id=IPortal>Direct</SPAN>
					</TD>
				</TR>
				<TR class=text2>
					<TD>&nbsp;&nbsp;&nbsp;&nbsp;Host:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						<SPAN id=IPath>https://imds-octf.csd.disa.mil/</SPAN>
					</TD>
				</TR>
			</TBODY>
		</TABLE>
	</DIV>

</BODY>

<script>


	function runIt() {
		var init = false;
		// var url = "http://localhost:4200";
		var url = "https://cs2.eis.af.mil/sites/10383/mdrp/_vti_bin/ListData.svc";
		var mdrp = window.open();
		mdrp.location = url;

		window.popup = mdrp;

		window.addEventListener('message', receiveMessage, false);
		waitForInit();

		function waitForInit() {
			if (init) {
				console.log("app initialized");
			} else {
				console.log("wait for activation...");
				sendMessage({ ACTIVATE: true });
				setTimeout(waitForInit, 250);
			}
		}

		function receiveMessage(message) {

			console.log(message);

			message = message.data || {}
			var state = Object.keys(message)[0];
			var data = message[state];

			if (!state || !data) {
				console.log("unknown post message");
				return;
			}

			switch (state) {

				case "IMDS_SYNC_HTML":
					init = true;
					document.write(data);
					break;

				case "START_SYNC":
					postToIMDS(data.orgId);
					break;

			}

		}

		function sendMessage(data) {
			mdrp.postMessage(data, "*");
		}

		function postToIMDS(orgId) {
			var url = "/txl/TtwTxn";

			var data = {
				R0_C0_L0_Y: "GDM" + orgId
			};

			var json = JSON.stringify(data);

			var xhr = new XMLHttpRequest();
			xhr.open("POST", url, true);
			xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
			xhr.onload = function () {
				var users = JSON.parse(xhr.responseText);
				if (xhr.readyState == 4 && xhr.status == "201") {
					sendMessage({
						IMDS_RECEIVE_380_XML: xhr.responseText
					});
				} else {
					console.error(users);
				}
			}
			xhr.send(json);
		}

	}

	setTimeout(runIt, 100);


</script>

</HTML>